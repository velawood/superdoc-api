# Codebase Structure

**Analysis Date:** 2026-02-06

## Directory Layout

```
superdoc-api/
├── superdoc-redline.mjs        # CLI entry point - command dispatcher
├── package.json                # Node.js project metadata
├── README.md                   # User documentation
├── SKILL.md                    # AI agent task guide
├── LICENSE                     # Apache 2.0 license
├── src/                        # Core library modules
│   ├── app.mjs                 # Fastify app factory (buildApp)
│   ├── server.mjs              # Server entry point (listen)
│   ├── routes/
│   │   └── health.mjs          # GET /health route handler
│   ├── plugins/
│   │   ├── request-id.mjs      # X-Request-Id onSend hook
│   │   └── error-handler.mjs   # Structured error/404 handlers
│   ├── editorFactory.mjs       # Headless SuperDoc editor creation
│   ├── irExtractor.mjs         # Extract IR from DOCX
│   ├── idManager.mjs           # UUID ↔ seqId mapping
│   ├── documentReader.mjs      # LLM-ready document reading
│   ├── chunking.mjs            # Token-aware document chunking
│   ├── editApplicator.mjs      # Execute edits on documents
│   ├── editMerge.mjs           # Merge edits from multiple sources
│   ├── blockOperations.mjs     # Low-level edit operations
│   ├── markdownEditsParser.mjs # Parse markdown edit format
│   ├── clauseParser.mjs        # Detect clauses and headings
│   ├── wordDiff.mjs            # Word-level diff via DMP
│   ├── fuzzyMatch.mjs          # Fuzzy text matching
│   └── textUtils.mjs           # Text normalization
├── tests_and_others/           # Test suite
│   └── tests/
│       ├── *.test.mjs          # Test files (Node.js built-in test runner)
│       └── fixtures/           # Test data
├── skills/                     # Example workflows for AI agents
│   ├── CONTRACT-REVIEW-SKILL.md
│   └── CONTRACT-REVIEW-AGENTIC-SKILL.md
├── .planning/codebase/         # Documentation (auto-generated by gsd mapper)
└── .gitignore                  # Git exclusions
```

## Directory Purposes

**Root Level:**
- Purpose: Entry point and project configuration
- Key files: `superdoc-redline.mjs` (CLI dispatch), `package.json` (dependencies)

**src/:**
- Purpose: Core business logic organized by concern
- Contains: 13 modules covering document I/O, processing pipeline, text utilities
- Key files: `irExtractor.mjs` (extraction), `editApplicator.mjs` (modification), `idManager.mjs` (ID mapping)

**tests_and_others/tests/:**
- Purpose: Test suite for all modules
- Contains: `.test.mjs` files using Node.js built-in test runner
- Key files: Corresponding test file for each major module
- Fixtures: Sample DOCX files and expected outputs in `fixtures/` subdirectory

**skills/:**
- Purpose: Example AI agent workflows and task guides
- Contains: Markdown documentation with decision flows, constraints, examples
- Usage: Reference for agents using this library for contract review

**.planning/codebase/:**
- Purpose: Architecture documentation (auto-generated)
- Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md

## Key File Locations

**Entry Points:**
- `src/server.mjs`: HTTP server entry point (Fastify, port 3000)
- `src/app.mjs`: App factory for server and test use (buildApp)
- `superdoc-redline.mjs`: Main CLI dispatcher, command handlers, argument parsing (450+ lines)

**Configuration:**
- `package.json`: Dependencies, scripts, metadata
- No .eslintrc, .prettierrc, or tsconfig.json (no build step, pure ES modules)

**Core Logic - Extraction:**
- `src/irExtractor.mjs`: Block extraction, ID assignment, outline building, defined terms extraction

**Core Logic - Editing:**
- `src/editApplicator.mjs`: Validation, sorting, operation dispatch
- `src/blockOperations.mjs`: Replace/delete/insert/comment operations
- `src/editMerge.mjs`: Multi-source merge with conflict resolution

**Core Logic - Reading:**
- `src/documentReader.mjs`: Chunking orchestration, format selection
- `src/chunking.mjs`: Token estimation, chunk boundary detection

**Core Logic - Utilities:**
- `src/idManager.mjs`: UUID↔seqId bidirectional mapping
- `src/wordDiff.mjs`: Character/word-level diff computation
- `src/clauseParser.mjs`: Clause numbering and heading detection
- `src/markdownEditsParser.mjs`: Markdown ↔ JSON edit conversion
- `src/fuzzyMatch.mjs`: Fuzzy text matching with markdown noise handling
- `src/textUtils.mjs`: Text normalization (whitespace, quotes)

**Document Access:**
- `src/editorFactory.mjs`: Headless editor creation, JSDOM setup

**Testing:**
- `tests_and_others/tests/*.test.mjs`: Test suites (chunking, documentReader, wordDiff, editMerge, CLI)
- `tests_and_others/tests/fixtures/`: Sample DOCX files

## Naming Conventions

**Files:**
- Pattern: `camelCase.mjs` for all modules
- Example: `editApplicator.mjs`, `blockOperations.mjs`, `irExtractor.mjs`
- CLI entry: `superdoc-redline.mjs` (kebab-case following CLI convention)

**Directories:**
- Pattern: lowercase, no abbreviations
- Example: `src/`, `tests_and_others/`, `skills/`
- Rationale: Simple, standard Node.js structure

**Functions:**
- Pattern: camelCase, action verbs for main exports
- Example: `extractDocumentIR()`, `readDocument()`, `applyEdits()`, `mergeEditFiles()`
- Internal helpers: camelCase with no special prefix

**Classes:**
- Pattern: PascalCase
- Example: `IdManager`, `Clause`
- Used for complex state management

**Variables:**
- Pattern: camelCase, descriptive names
- Example: `idManager`, `editConfig`, `blockIdsSet`, `idsAssigned`
- Maps/lookups: `Map` type with descriptive keys

**Comments:**
- Pattern: JSDoc blocks for exports, inline for complex logic
- Example: `/**\n * @param {string} blockId - ...\n * @returns {string|null} - ...\n */`

## Where to Add New Code

**New Edit Operation Type:**
- Implementation: `src/blockOperations.mjs`
  - Add function matching pattern: `function operation<Name>ByBlock(editor, blockId, ...options)`
  - Register in `blockOperations` dispatch logic
- Validation: `src/editApplicator.mjs`
  - Add validation in `validateSingleEdit()` function
  - Add operation type to `validateEditConfig()` switch
- CLI: `superdoc-redline.mjs`
  - Add to edit configuration documentation (lines 28-39)
  - No CLI command change needed (uses apply command with edits JSON)

**New Text Processing Utility:**
- Location: `src/textUtils.mjs` (general) or new module if specialized
- Pattern: Export utility function, JSDoc with examples
- Used by: `blockOperations.mjs`, `markdownEditsParser.mjs`, etc.

**New Document Format Support:**
- Reading: Add parser in `src/markdownEditsParser.mjs` or new format module
- Application: Extend `editApplicator.applyEdits()` to detect and parse format
- CLI: Modify `superdoc-redline.mjs` apply command to auto-detect format

**New CLI Command:**
- Location: Add command definition in `superdoc-redline.mjs` after existing commands
- Pattern: Use `program.command()`, `.description()`, `.option()`, `.action(async (options) => {})`
- Core logic: Import from `src/` modules
- Output: JSON to stdout or files via fs/promises

**Testing New Feature:**
- Location: `tests_and_others/tests/` as `<moduleName>.test.mjs`
- Runner: Node.js built-in test runner (`node --test`)
- Fixtures: Place sample DOCX in `tests_and_others/tests/fixtures/`
- Pattern: Use descriptive test names with clear setup/assertion sections

## Special Directories

**node_modules/:**
- Purpose: Dependencies (gitignored)
- Generated: Yes (via npm install)
- Committed: No
- Key deps: `@harbour-enterprises/superdoc`, `commander`, `jsdom`, `diff-match-patch`, `archiver`, `unzipper`, `fastify`, `fastify-plugin`

**.git/:**
- Purpose: Version control
- Generated: Yes (git init)
- Committed: No

**.planning/codebase/:**
- Purpose: Auto-generated architecture documentation
- Generated: Yes (via gsd mapper)
- Committed: Yes (tracked in git)

**.osgrep/:**
- Purpose: Internal tool metadata (purpose unclear from structure alone)
- Generated: Yes
- Committed: No (should be)

## Module Dependency Graph

```
superdoc-redline.mjs
  ├── src/irExtractor.mjs
  │   ├── src/editorFactory.mjs
  │   ├── src/idManager.mjs
  │   ├── src/clauseParser.mjs
  │   └── fs/promises
  ├── src/documentReader.mjs
  │   ├── src/irExtractor.mjs
  │   └── src/chunking.mjs
  ├── src/editApplicator.mjs
  │   ├── src/editorFactory.mjs
  │   ├── src/irExtractor.mjs
  │   ├── src/blockOperations.mjs
  │   │   ├── src/wordDiff.mjs
  │   │   ├── src/textUtils.mjs
  │   │   └── src/fuzzyMatch.mjs
  │   ├── src/editMerge.mjs
  │   └── fs/promises
  ├── src/editMerge.mjs
  │   └── fs/promises
  ├── src/markdownEditsParser.mjs
  │   └── (no dependencies)
  └── path, fs/promises
```

**Acyclic:** No circular dependencies detected. Safe refactoring.

**Core Flows:**
- Extract → IR (read-only)
- Read + Chunk → IR (read-only)
- Validate/Apply → IR + Editor + BlockOps (mutable)
- Merge → Edit files (read-only)

## Import Path Style

**External modules:**
```javascript
import { Editor } from '@harbour-enterprises/superdoc/super-editor';
import { readFile } from 'fs/promises';
import { program } from 'commander';
```

**Internal modules:**
```javascript
import { extractDocumentIR } from './irExtractor.mjs';
import { createIdManager } from './idManager.mjs';
```

**Pattern:** Relative imports (./filename.mjs) for same-directory files. No path aliases, no barrel exports.

## Performance Considerations

**File sizes (lines of code):**
- Large: `editApplicator.mjs` (629), `irExtractor.mjs` (376), `blockOperations.mjs` (651)
- Medium: `editMerge.mjs` (343), `documentReader.mjs` (280), `clauseParser.mjs` (247)
- Small: Utilities, factories, managers (<100 lines each)

**Load time:** No build step. Direct ES module execution.

**Memory:** In-memory document loading via JSDOM. No streaming support.

