---
phase: 01-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - tests_and_others/tests/server.test.mjs
autonomous: true

must_haves:
  truths:
    - "Tests prove GET /health returns {status:ok} with 200"
    - "Tests prove GET /v1/health returns {status:ok} with 200"
    - "Tests prove every response includes X-Request-Id header (UUID format)"
    - "Tests prove client-provided X-Request-Id is echoed back unchanged"
    - "Tests prove unknown routes return 404 with structured error JSON"
    - "Tests prove server errors return 500 with safe message (no stack trace)"
    - "Tests prove validation errors return 400 with field-level details"
    - "Tests prove 404 error responses still include X-Request-Id"
    - "All tests pass via npm test"
  artifacts:
    - path: "tests_and_others/tests/server.test.mjs"
      provides: "Comprehensive server behavior tests"
      contains: "describe.*health|describe.*request.id|describe.*error|describe.*versioning"
  key_links:
    - from: "tests_and_others/tests/server.test.mjs"
      to: "src/app.mjs"
      via: "import buildApp, use app.inject()"
      pattern: "import.*buildApp.*from.*app"
---

<objective>
Write comprehensive tests for all Phase 1 server behaviors using TDD with fastify.inject().

Purpose: Verify all 5 success criteria from the roadmap are met, and lock down the server's behavior contract before building on it in later phases. Tests use fastify.inject() (no real server needed), following existing project test conventions (node:test + node:assert/strict).

Output: A single test file covering health check, request ID tracing, structured errors, HTTP status codes, and API versioning.
</objective>

<execution_context>
@/Users/alin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md
</context>

<feature>
  <name>Server behavior contract</name>
  <files>tests_and_others/tests/server.test.mjs, src/app.mjs</files>
  <behavior>
All tests use fastify.inject() against buildApp({logger: false}). No real server started.

Follow existing test conventions from TESTING.md:
- Import from "node:test" (describe, it, before, after)
- Import from "node:assert/strict"
- Descriptive test names
- Arrange/Act/Assert pattern

Test suites and cases:

**Suite 1: Health Check (INFRA-01)**
- GET /health returns 200 with {"status":"ok"}
- GET /v1/health returns 200 with {"status":"ok"}
- Response Content-Type is application/json

**Suite 2: Request ID Tracing (INFRA-02)**
- Response includes X-Request-Id header
- X-Request-Id is a valid UUID v4 format (regex: /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/)
- Client-provided X-Request-Id is echoed back unchanged
- Each request gets a unique X-Request-Id when not provided
- Error responses also include X-Request-Id

**Suite 3: Structured Errors (INFRA-03)**
- Unknown route returns {error: {code: "NOT_FOUND", message: string, details: []}}
- error.message includes the method and URL attempted
- error.details is always an array (even if empty)

**Suite 4: HTTP Status Codes (INFRA-04)**
- Unknown route returns HTTP 404
- Server error returns HTTP 500 (test by registering a route that throws)
- 500 error message is generic ("An internal server error occurred"), not the actual error
- Validation error returns HTTP 400 with details array (test by registering a route with JSON schema)

**Suite 5: API Versioning (INFRA-07)**
- GET /v1/health returns 200 (endpoints exist under /v1/)
- GET /v2/health returns 404 (only v1 exists)

Edge cases to test:
- Multiple rapid requests get distinct X-Request-Id values
- X-Request-Id with non-UUID value from client is still echoed
- POST to /health returns 404 (only GET is defined)
  </behavior>
  <implementation>
Create tests_and_others/tests/server.test.mjs following the RED-GREEN-REFACTOR cycle.

**RED phase:** Write all test cases. They should fail if the server code has bugs, pass if correct. Since Plan 01 creates the implementation first, tests should pass immediately if implementation is correct.

**GREEN phase:** If any test fails, fix the implementation in src/app.mjs or its plugins. For testing validation errors (400) and server errors (500), register temporary test routes inside the test file using the app instance:

```javascript
// For testing 500 errors
const app = buildApp({logger: false});
app.get("/test-error", async () => { throw new Error("test boom"); });

// For testing 400 validation errors
app.post("/test-validate", {
  schema: {
    body: {
      type: "object",
      required: ["name"],
      properties: { name: { type: "string" } }
    }
  }
}, async (request) => ({ ok: true }));
```

**REFACTOR phase:** Clean up test structure, ensure consistent patterns, add any missing edge cases.

Update package.json test script to include server tests:
- Change: "test": "node --test tests_and_others/tests/*.test.mjs"
- This glob already covers server.test.mjs, so no change needed if the file is in that directory.
  </implementation>
</feature>

<verification>
```bash
# All tests pass
npm test

# Server test file specifically passes
node --test tests_and_others/tests/server.test.mjs

# Count test cases (should be 15+)
node --test tests_and_others/tests/server.test.mjs 2>&1 | grep -c "ok\|not ok"
```
</verification>

<success_criteria>
- tests_and_others/tests/server.test.mjs exists with 15+ test cases
- All test cases pass via `node --test tests_and_others/tests/server.test.mjs`
- Existing tests still pass via `npm test` (no regressions)
- Tests cover all 5 success criteria from the Phase 1 roadmap
- Tests use fastify.inject() (no real server started during tests)
- Tests follow existing project conventions (node:test, assert/strict, describe/it, .mjs extension)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
